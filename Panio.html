<!DOCTYPE html>
<html>
<head><title>SOUND</title></head>
<body>
<div>Frequence: <span id="frequency"></span></div>
<script type="text/javascript">

var audioCtx = new (window.AudioContext || window.webkitAudioContext)();

/**Calculates the piano frequency for  key
 * @return {number}
 */
function FrequencyCalculation(key){
    var baseFreq = 440;
    var baseRoot = Math.pow(2,(1/12));//12th root of 2
    return Math.pow(baseRoot,(key-49))*baseFreq;
}
var keys = {
    81:{frequency:FrequencyCalculation(28), isDown:false},    //q - c3
    87:{frequency:FrequencyCalculation(30), isDown:false},    //w - d3
    69:{frequency:FrequencyCalculation(32), isDown:false},    //e - e3
    82:{frequency:FrequencyCalculation(33), isDown:false},    //r - f3
    84:{frequency:FrequencyCalculation(35), isDown:false},    //t - g3
    89:{frequency:FrequencyCalculation(37), isDown:false},    //y - a3
    85:{frequency:FrequencyCalculation(39), isDown:false},    //u - b3
    73:{frequency:FrequencyCalculation(40), isDown:false},    //i - c4
    79:{frequency:FrequencyCalculation(42), isDown:false},    //o - d4
    80:{frequency:FrequencyCalculation(44), isDown:false},    //p - e4
    219:{frequency:FrequencyCalculation(45), isDown:false},   //[ - f4
    221:{frequency:FrequencyCalculation(47), isDown:false}    //] - g4
};
real= [0, 0, -0.203569, 0.5, -0.401676, 0.137128, -0.104117, 0.115965,
    -0.004413, 0.067884, -0.00888, 0.0793, -0.038756, 0.011882,
    -0.030883, 0.027608, -0.013429, 0.00393, -0.014029, 0.00972,
    -0.007653, 0.007866, -0.032029, 0.046127, -0.024155, 0.023095,
    -0.005522, 0.004511, -0.003593, 0.011248, -0.004919, 0.008505];
imag= [0, 0.147621, 0, 0.000007, -0.00001, 0.000005, -0.000006, 0.000009,
    0, 0.000008, -0.000001, 0.000014, -0.000008, 0.000003,
    -0.000009, 0.000009, -0.000005, 0.000002, -0.000007, 0.000005,
    -0.000005, 0.000005, -0.000023, 0.000037, -0.000021, 0.000022,
    -0.000006, 0.000005, -0.000004, 0.000014, -0.000007, 0.000012];
var wave = audioCtx.createPeriodicWave(real, imag, {disableNormalization: false});
var NotesInPlay = [];
var pedalOnDelay = 2;
var pedalOffDelay = 0.3;
var pedalDelay = pedalOffDelay;


function Note(key){
    var oscillatorNode = audioCtx.createOscillator();
    var gainNode = audioCtx.createGain();
    gainNode.gain.setValueAtTime(0.5,audioCtx.currentTime);
    oscillatorNode.frequency.setValueAtTime(key.frequency, audioCtx.currentTime);
    oscillatorNode.setPeriodicWave(wave);
    oscillatorNode.connect(gainNode);
    oscillatorNode.start();
    gainNode.connect(audioCtx.destination);
    this.Key = key;
    this.Play = function(Delay){
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+Delay);
        gainNode.gain.setValueAtTime(0, audioCtx.currentTime+Delay);
        oscillatorNode.stop(audioCtx.currentTime+Delay);
    };
}

document.addEventListener('keydown', function(event) {
    if (event.keyCode === 32) { // space bar
        pedalDelay = pedalOnDelay;
    }else if(!keys[event.keyCode].isDown){
        keys[event.keyCode].isDown = true;
        var note = new Note(keys[event.keyCode]);
        NotesInPlay.push(note);
        note.Play(pedalOnDelay)
	}

});

document.addEventListener('keyup', function(event) {

    if (event.keyCode === 32) { // space bar
        pedalDelay =pedalOffDelay;
    }else if(keys[event.keyCode].isDown){
        keys[event.keyCode].isDown = false;
    }
    NotesInPlay.forEach(function(Note,index){
        if(((event.keyCode === 32) || Note.Key.frequency===keys[event.keyCode].frequency) && !(Note.Key.isDown)){
            Note.Play(pedalDelay);
        }
    });
});    

</script>
</body>
</html>
